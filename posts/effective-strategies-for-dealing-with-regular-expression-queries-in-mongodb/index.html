<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Effective strategies for dealing with regular expression queries in MongoDB" /><meta property="og:locale" content="en" /><meta name="description" content="Thanks to my teammate Daniel Perdomo for his help. I couldn’t have done it without you. 🙏" /><meta property="og:description" content="Thanks to my teammate Daniel Perdomo for his help. I couldn’t have done it without you. 🙏" /><link rel="canonical" href="https://jcarloslr10.github.io/posts/effective-strategies-for-dealing-with-regular-expression-queries-in-mongodb/" /><meta property="og:url" content="https://jcarloslr10.github.io/posts/effective-strategies-for-dealing-with-regular-expression-queries-in-mongodb/" /><meta property="og:site_name" content="Juan Carlos López" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-02T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Effective strategies for dealing with regular expression queries in MongoDB" /><meta name="twitter:site" content="@jcarloslr10" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-13T20:13:26+02:00","datePublished":"2022-05-02T00:00:00+02:00","description":"Thanks to my teammate Daniel Perdomo for his help. I couldn’t have done it without you. 🙏","headline":"Effective strategies for dealing with regular expression queries in MongoDB","mainEntityOfPage":{"@type":"WebPage","@id":"https://jcarloslr10.github.io/posts/effective-strategies-for-dealing-with-regular-expression-queries-in-mongodb/"},"url":"https://jcarloslr10.github.io/posts/effective-strategies-for-dealing-with-regular-expression-queries-in-mongodb/"}</script><title>Effective strategies for dealing with regular expression queries in MongoDB | Juan Carlos López</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Juan Carlos López"><meta name="application-name" content="Juan Carlos López"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><meta name="google-site-verification" content="RYfhY0x_-nuFQ4N7CKDAm3oWUsySKvxoIUO-txMspQo" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://avatars.githubusercontent.com/u/15978818?v=4 " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Juan Carlos López</a></div><div class="site-subtitle font-italic">Software engineer @ Plain Concepts</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jcarloslr10" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/jcarloslr10" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['tmac.juancar.24','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Effective strategies for dealing with regular expression queries in MongoDB</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Effective strategies for dealing with regular expression queries in MongoDB</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/jcarloslr10">Juan Carlos López</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1651442400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-02 </em> </span> <span> Updated <em class="timeago" data-ts="1652465606" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2336 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><blockquote><p>Thanks to my teammate <a href="https://www.linkedin.com/in/daniel-perdomo-lorenzo-35b5a070/" target="_blank"><em>Daniel Perdomo</em></a> for his help. I couldn’t have done it without you. 🙏</p></blockquote><h2 id="the-millenium-problem"><span class="mr-2">The Millenium Problem</span><a href="#the-millenium-problem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Some of us have worked building applications where, at some point, they need to filter data based on a specified pattern. At first glance, it may seem like a simple problem to solve, but it can hide a poison dart behind it.</p><p>It all starts when a stakeholder tells us that the end-user has a need to filter data based on text matching. We, as conscientious software engineer, ask the following questions:</p><blockquote><p>“Does it have to be an exact text matching?”</p></blockquote><blockquote><p>“Does it have to be a <strong>smarter</strong> text matching by taking singular and plural terms into account and skipping stop words?”</p></blockquote><p>If the answer to the <strong>second question is yes</strong>, we should consider paths related to <a href="https://www.mongodb.com/docs/manual/core/index-text/" target="_blank"><strong>text indexes</strong></a> in MongoDB or, for more demanding scenarios, other technologies such as <a href="https://www.mongodb.com/docs/atlas/atlas-search/" target="_blank"><strong>Atlas Search</strong></a> or <a href="https://www.elastic.co/what-is/elasticsearch" target="_blank"><strong>Elasticsearch</strong></a>.</p><p>If the answer to the <strong>first question is yes</strong> then we should consider use <a href="https://www.mongodb.com/docs/manual/indexes/" target="_blank"><strong>regular indexes</strong></a>, although we still have one more question to ask:</p><blockquote><p>“Can the pattern match only against the values from the beginning of the string (<strong>prefix pattern</strong>) or anywhere (<strong>LIKE-style</strong>)?”</p></blockquote><p>Fortunately, if the answer to the question is <em>“It only matches against the values from the beginning…”</em> then we just dodged a bullet 😁 because filtering prefix patterns over text index in MongoDB is the least bad thing that can happen to us since it is efficient enough. But, if the answer to the question is <em>“Anywhere…“</em>, then we are in trouble. 😥</p><p>By the way, before continuing, the stakeholders also ask us to make the matchings insensitive to uppercase, lowercase and diacritics… 😭</p><h2 id="regex-operator"><span class="mr-2">Regex operator</span><a href="#regex-operator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>First, I would like to introduce the <code class="language-plaintext highlighter-rouge">$regex</code> operator in MongoDB. The operator accepts a regular expression of the following form <code class="language-plaintext highlighter-rouge">/pattern/&lt;options&gt;</code>. An example of non-prefix pattern might be <code class="language-plaintext highlighter-rouge">/cor/i</code> which looks for the term <strong>cor</strong> anywhere in the string and insensitively.</p><p>This type of approach poses two problems, even using regular indexes:</p><ol><li>The use of non-prefix pattern does not allow setting boundaries when going through the data to be filtered.<li>The option flag <code class="language-plaintext highlighter-rouge">i</code> causes MongoDB to perform insensitive comparisons which is more inefficient.</ol><h2 id="use-case"><span class="mr-2">Use case</span><a href="#use-case" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>The application that we are building has a list of users. A end-user of this application has to be able to search users by full name, but to perform meaningful searches on the data, at least one term of <strong>at least three alphanumeric characters</strong> must be typed into the text search box.</p><p>This limitation on the minimum size of the term is set because searches for <strong>below three characters</strong> will not yield consistent and useful results.</p><p>Examples of <strong>correct</strong> searches: <code class="language-plaintext highlighter-rouge">Bry</code> <code class="language-plaintext highlighter-rouge">Bryan</code> <code class="language-plaintext highlighter-rouge">cor Be</code></p><p>Examples of <strong>incorrect</strong> searches: <code class="language-plaintext highlighter-rouge">b</code> <code class="language-plaintext highlighter-rouge">Br</code> <code class="language-plaintext highlighter-rouge">r b</code> <code class="language-plaintext highlighter-rouge">or Be</code></p><h4 id="user-model"><span class="mr-2">User model</span><a href="#user-model" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>The below JSON represents a user in the <code class="language-plaintext highlighter-rouge">users</code> collection in MongoDB.</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$oid"</span><span class="p">:</span><span class="s2">"626d70bcc30933f61a0786e3"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Corey Batz"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"job"</span><span class="p">:</span><span class="s2">"Legacy Usability Consultant"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h4 id="user-query"><span class="mr-2">User query</span><a href="#user-query" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>The below Javascript represents how the data are queried using an insensitive non-prefix pattern.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">).</span><span class="nx">aggregate</span><span class="p">([</span>
    <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="p">{</span> <span class="na">$regex</span><span class="p">:</span> <span class="sr">/corey ba/i</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">])</span>
</pre></table></code></div></div><p>Next, we are going to run the queries on the <code class="language-plaintext highlighter-rouge">users</code> collection which has <strong>1,000,000 documents</strong>, so stay tuned.</p><h2 id="avoiding-insensitive-flag"><span class="mr-2">Avoiding insensitive flag</span><a href="#avoiding-insensitive-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>Building on the user data model above, a new field called <code class="language-plaintext highlighter-rouge">normalizedName</code> could be added to store the normalized name (lowercase, no diacritics, single space) on which to match later. That may be possible by normalizing the search terms before trying to query them.</p><p>So we would have the below JSON representation in the <code class="language-plaintext highlighter-rouge">users</code> collection:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$oid"</span><span class="p">:</span><span class="s2">"626d70bcc30933f61a0786e3"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Corey Batz"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="s2">"corey batz"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"job"</span><span class="p">:</span><span class="s2">"Legacy Usability Consultant"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>And the query would look like this:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">).</span><span class="nx">aggregate</span><span class="p">([</span>
    <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="na">normalizedName</span><span class="p">:</span> <span class="p">{</span> <span class="na">$regex</span><span class="p">:</span> <span class="sr">/corey ba/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">])</span>
</pre></table></code></div></div><p>At least this solution will prevent MongoDB from having to perform insensitive comparisons, although it is not enough to guarantee proper operation in a production environment.</p><p>It seems we will have to create an index to make the <code class="language-plaintext highlighter-rouge">$regex</code> expression more efficient because so far MongoDB is scanning the collection. Let’s go there!</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">).</span><span class="nx">createIndex</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">normalizedName</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ix_normalizedName</span><span class="dl">"</span> <span class="p">}</span>
<span class="p">);</span>
</pre></table></code></div></div><p>If we run the query again and take a look at the query plan we can see the following:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"explainVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"queryPlanner"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"crm.users"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"indexFilterSet"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parsedQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rey li"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"optimizedPipeline"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxIndexedOrSolutionsReached"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxIndexedAndSolutionsReached"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxScansToExplodeReached"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"winningPlan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"stage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FETCH"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputStage"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"stage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IXSCAN"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rey li"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"keyPattern"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"indexName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ix_normalizedName"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isMultiKey"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"multiKeyPaths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"isUnique"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isSparse"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isPartial"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"indexVersion"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"forward"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"indexBounds"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"[</span><span class="se">\"\"</span><span class="s2">, {})"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"[/rey li/, /rey li/]"</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"rejectedPlans"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"executionStats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"executionSuccess"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"nReturned"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"executionTimeMillis"</span><span class="p">:</span><span class="w"> </span><span class="mf">1048.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"totalKeysExamined"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000000.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"totalDocsExamined"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"executionStages"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"stage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FETCH"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"nReturned"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"executionTimeMillisEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mf">93.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"works"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000001.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"advanced"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"needTime"</span><span class="p">:</span><span class="w"> </span><span class="mf">999960.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"needYield"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"saveState"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"restoreState"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isEOF"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"docsExamined"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"alreadyHasObj"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputStage"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"stage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IXSCAN"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rey li"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"nReturned"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"executionTimeMillisEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mf">92.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"works"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000001.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"advanced"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"needTime"</span><span class="p">:</span><span class="w"> </span><span class="mf">999960.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"needYield"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"saveState"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"restoreState"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isEOF"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"keyPattern"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"indexName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ix_normalizedName"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isMultiKey"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"multiKeyPaths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"isUnique"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isSparse"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isPartial"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"indexVersion"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"forward"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"indexBounds"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"[</span><span class="se">\"\"</span><span class="s2">, {})"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"[/rey li/, /rey li/]"</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"keysExamined"</span><span class="p">:</span><span class="w"> </span><span class="mf">1000000.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"seeks"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"dupsTested"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"dupsDropped"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"allPlansExecution"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pipeline"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"$match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="err">/rey</span><span class="w"> </span><span class="err">li/</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"cursor"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="nl">"$db"</span><span class="p">:</span><span class="w"> </span><span class="s2">"crm"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"serverInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"serverParameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"ok"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Analyzing the query plan we see that MongoDB takes the previously created index as the first stage of the winning plan:</p><p><code class="language-plaintext highlighter-rouge">queryPlanner.winningPlan.inputStage.stage: "IXSCAN"</code> <code class="language-plaintext highlighter-rouge">queryPlanner.winningPlan.inputStage.indexName: "ix_normalizedName"</code></p><p>That’s good! But what about the amount of work using the index?</p><p>Well, if we see the total number of index key examined, we will be stunned. MongoDB scanned the whole index (<strong>1,000,000 keys</strong>) to end up returning <strong>40 documents</strong> and it took 1,048 milliseconds to execute it. 🥴</p><p><code class="language-plaintext highlighter-rouge">executionStats.executionTimeMillis: 1048.0</code></p><p><code class="language-plaintext highlighter-rouge">executionStats.totalKeysExamined: 1000000.0</code></p><p><code class="language-plaintext highlighter-rouge">executionStats.totalDocsExamined: 40.0</code></p><p><code class="language-plaintext highlighter-rouge">executionStats.nReturned: 40.0</code></p><p>As the <code class="language-plaintext highlighter-rouge">$regex</code> is non-prefix expression, MongoDB cannot optimize the <code class="language-plaintext highlighter-rouge">IXSCAN</code> stage setting bounds when scanning the index, so we need a strategy for MongoDB to be able to set these bounds to do the index scan and return results faster.</p><h2 id="querying-efficient-non-prefix-pattern"><span class="mr-2">Querying efficient non-prefix pattern</span><a href="#querying-efficient-non-prefix-pattern" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>As stated before, it’s assumed that at least three alphanumeric character term is typed into text search box in order to perform meaningful searches, so let’s define the strategy that will change our lives. 🤨</p><h3 id="the-algorithm-"><span class="mr-2">The Algorithm 🚀</span><a href="#the-algorithm-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Since we only perform searches if the search term has three alphanumeric characters, we could add a new field called <code class="language-plaintext highlighter-rouge">normalizedNameChunks</code> to store all the three-character chunks of the <code class="language-plaintext highlighter-rouge">normalizedName</code> field including words with less than three characters as well. Let me explain:</p><p>Taking the <code class="language-plaintext highlighter-rouge">normalizedName</code> <strong>“corey li batz”</strong> as an example, we would do the following:</p><ol><li>Split the <code class="language-plaintext highlighter-rouge">normalizedName</code> by spaces, outputting: <code class="language-plaintext highlighter-rouge">["corey", "li", "batz"]</code><li>Divide each word into as many three-character chunks as possible and keep words less than three characters as is, outputting: <code class="language-plaintext highlighter-rouge">["cor", "ore", "rey", "li", "bat", "atz"]</code></ol><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$oid"</span><span class="p">:</span><span class="s2">"626d70bcc30933f61a0786e3"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Corey Li Batz"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="s2">"corey li batz"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"normalizedNameChunks"</span><span class="p">:[</span><span class="s2">"cor"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ore"</span><span class="p">,</span><span class="w"> </span><span class="s2">"rey"</span><span class="p">,</span><span class="w"> </span><span class="s2">"li"</span><span class="p">,</span><span class="w"> </span><span class="s2">"bat"</span><span class="p">,</span><span class="w"> </span><span class="s2">"atz"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"job"</span><span class="p">:</span><span class="s2">"Legacy Usability Consultant"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Using this approach, we could search for matches on this new field, but first we would need to apply the same steps to the search text input.</p><p>Taking the search text input <strong>“rey li”</strong> as an example, we would do the following:</p><ol><li>Split the text input by spaces, outputting: <code class="language-plaintext highlighter-rouge">["rey", "li"]</code><li>Divide each word into as many three-character chunks as possible and keep words less than three characters as is, outputting: <code class="language-plaintext highlighter-rouge">["rey", "li"]</code></ol><p>Thus, we could build a query that finds an intersection between the array of the <code class="language-plaintext highlighter-rouge">normalizedNameChunks</code> field and the array of the text input.</p><p><code class="language-plaintext highlighter-rouge">["cor", "ore", "rey", "li", "bat", "atz"] ∩ ["rey", "li"] = ["rey"]</code></p><p>Using the <code class="language-plaintext highlighter-rouge">$in</code> array operator we manage to perform the intersection operation between array field and input array, creating the query as follows:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">).</span><span class="nx">aggregate</span><span class="p">([</span>
    <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="na">normalizedNameChunks</span><span class="p">:</span> <span class="p">{</span> <span class="na">$in</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">rey</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">li</span><span class="dl">"</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">])</span>
</pre></table></code></div></div><p>The intersection operations means that there are matches between the arrays, but the problem with this new query is that it does not guarantee that the order of the chunks is correct, so we need to do something else on the query:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">).</span><span class="nx">aggregate</span><span class="p">([</span>
    <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="na">normalizedNameChunks</span><span class="p">:</span> <span class="p">{</span> <span class="na">$in</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">rey</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">li</span><span class="dl">"</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="na">normalizedName</span><span class="p">:</span> <span class="p">{</span> <span class="na">$regex</span><span class="p">:</span> <span class="sr">/rey li/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">])</span>
</pre></table></code></div></div><p>The new stage filtering by <code class="language-plaintext highlighter-rouge">normalizedName</code> field using <code class="language-plaintext highlighter-rouge">$regex</code> expression will ensure that the order of the chunks is correct.</p><p>One more time as we have done before, we need to create a new index to support the new query conditions on <code class="language-plaintext highlighter-rouge">normalizedNameChunks</code> and <code class="language-plaintext highlighter-rouge">normalizedName</code> fields:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">users</span><span class="dl">"</span><span class="p">).</span><span class="nx">createIndex</span><span class="p">(</span>
  <span class="p">{</span> <span class="na">normalizedNameChunks</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">normalizedName</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ix_normalizedNameChunks_normalizedName</span><span class="dl">"</span> <span class="p">}</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Now we really have it all! Let’s see the query plan again.</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"explainVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"queryPlanner"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"crm.users"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"indexFilterSet"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parsedQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rey li"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedNameChunks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$in"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"li"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"rey"</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"optimizedPipeline"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxIndexedOrSolutionsReached"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxIndexedAndSolutionsReached"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"maxScansToExplodeReached"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"winningPlan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"stage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FETCH"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rey li"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"inputStage"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"stage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IXSCAN"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"keyPattern"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedNameChunks"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"indexName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ix_normalizedNameChunks_normalizedName"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isMultiKey"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"multiKeyPaths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedNameChunks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"normalizedNameChunks"</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"isUnique"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isSparse"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isPartial"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"indexVersion"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"forward"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"indexBounds"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedNameChunks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"[</span><span class="se">\"</span><span class="s2">li</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">li</span><span class="se">\"</span><span class="s2">]"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"[</span><span class="se">\"</span><span class="s2">rey</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">rey</span><span class="se">\"</span><span class="s2">]"</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"[</span><span class="se">\"\"</span><span class="s2">, {})"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"[/rey li/, /rey li/]"</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"rejectedPlans"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"executionStats"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"executionSuccess"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"nReturned"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"executionTimeMillis"</span><span class="p">:</span><span class="w"> </span><span class="mf">278.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"totalKeysExamined"</span><span class="p">:</span><span class="w"> </span><span class="mf">7018.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"totalDocsExamined"</span><span class="p">:</span><span class="w"> </span><span class="mf">7016.0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"executionStages"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"stage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FETCH"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rey li"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"nReturned"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"executionTimeMillisEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mf">207.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"works"</span><span class="p">:</span><span class="w"> </span><span class="mf">7019.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"advanced"</span><span class="p">:</span><span class="w"> </span><span class="mf">40.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"needTime"</span><span class="p">:</span><span class="w"> </span><span class="mf">6977.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"needYield"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"saveState"</span><span class="p">:</span><span class="w"> </span><span class="mf">17.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"restoreState"</span><span class="p">:</span><span class="w"> </span><span class="mf">17.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isEOF"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"docsExamined"</span><span class="p">:</span><span class="w"> </span><span class="mf">7016.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"alreadyHasObj"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"inputStage"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"stage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IXSCAN"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"nReturned"</span><span class="p">:</span><span class="w"> </span><span class="mf">7016.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"executionTimeMillisEstimate"</span><span class="p">:</span><span class="w"> </span><span class="mf">10.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"works"</span><span class="p">:</span><span class="w"> </span><span class="mf">7018.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"advanced"</span><span class="p">:</span><span class="w"> </span><span class="mf">7016.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"needTime"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"needYield"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"saveState"</span><span class="p">:</span><span class="w"> </span><span class="mf">17.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"restoreState"</span><span class="p">:</span><span class="w"> </span><span class="mf">17.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isEOF"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"keyPattern"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedNameChunks"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"indexName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ix_normalizedNameChunks_normalizedName"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isMultiKey"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"multiKeyPaths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedNameChunks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"normalizedNameChunks"</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"isUnique"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isSparse"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"isPartial"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"indexVersion"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"forward"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"indexBounds"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedNameChunks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"[</span><span class="se">\"</span><span class="s2">li</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">li</span><span class="se">\"</span><span class="s2">]"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"[</span><span class="se">\"</span><span class="s2">rey</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">rey</span><span class="se">\"</span><span class="s2">]"</span><span class="w">
          </span><span class="p">],</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"[</span><span class="se">\"\"</span><span class="s2">, {})"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"[/rey li/, /rey li/]"</span><span class="w">
          </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"keysExamined"</span><span class="p">:</span><span class="w"> </span><span class="mf">7018.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"seeks"</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"dupsTested"</span><span class="p">:</span><span class="w"> </span><span class="mf">7016.0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"dupsDropped"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"allPlansExecution"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pipeline"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"$match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedNameChunks"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$in"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"rey"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"li"</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"$match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"normalizedName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="err">/rey</span><span class="w"> </span><span class="err">li/</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"cursor"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="nl">"$db"</span><span class="p">:</span><span class="w"> </span><span class="s2">"crm"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"serverInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"serverParameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"ok"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Analyzing the query plan we see that MongoDB takes the previously created index as the first stage of the winning plan:</p><p><code class="language-plaintext highlighter-rouge">queryPlanner.winningPlan.inputStage.stage: "IXSCAN"</code> <code class="language-plaintext highlighter-rouge">queryPlanner.winningPlan.inputStage.indexName: "ix_normalizedNameChunks_normalizedName"</code></p><p>That’s awesome! But what about the amount of work using this index?</p><p>Well, if we see the total number of index key examined, we will be amazed. MongoDB scanned the index more efficiently setting bounds (<strong>7,018 keys</strong>) to end up returning <strong>40 documents</strong> and it took 278 milliseconds to execute it. Nice! 😎</p><p><code class="language-plaintext highlighter-rouge">executionStats.executionTimeMillis: 278.0</code></p><p><code class="language-plaintext highlighter-rouge">executionStats.totalKeysExamined: 7018.0</code></p><p><code class="language-plaintext highlighter-rouge">executionStats.totalDocsExamined: 7016.0</code></p><p><code class="language-plaintext highlighter-rouge">executionStats.nReturned: 40.0</code></p><h2 id="conclusions"><span class="mr-2">Conclusions</span><a href="#conclusions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><hr /><p>In summary, it is important to keep in mind the following key points:</p><ul><li><p>Avoid using inefficient regular expression patterns like non-prefix patterns <code class="language-plaintext highlighter-rouge">/batz/</code> or insensitive patterns <code class="language-plaintext highlighter-rouge">/batz/i</code>.</p><li><p>Try to use prefix patterns like <code class="language-plaintext highlighter-rouge">/^corey/</code> or <code class="language-plaintext highlighter-rouge">/batz$/</code> when using regular expressions so MongoDB can set bounds for scanning index.</p><li><p>Try to use a different field to store the normalized value of a given field in order to perform a insensitive comparison in terms of casing and diacritics.</p><li><p>Splitting words into chunks of a defined minimum length allow us to perform much more efficient first stage.</p><li><p>An <em>inefficient</em> second stage on a much smaller data set is much more <em>efficient</em> than an <em>inefficient</em> first stage on a very large data set.</p></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/data/'>Data</a>, <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/database/" class="post-tag no-text-decoration" >database</a> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/regex/" class="post-tag no-text-decoration" >regex</a> <a href="/tags/performance/" class="post-tag no-text-decoration" >performance</a> <a href="/tags/tuning/" class="post-tag no-text-decoration" >tuning</a> <a href="/tags/index/" class="post-tag no-text-decoration" >index</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Effective strategies for dealing with regular expression queries in MongoDB - Juan Carlos López&amp;url=https://jcarloslr10.github.io/posts/effective-strategies-for-dealing-with-regular-expression-queries-in-mongodb/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Effective strategies for dealing with regular expression queries in MongoDB - Juan Carlos López&amp;u=https://jcarloslr10.github.io/posts/effective-strategies-for-dealing-with-regular-expression-queries-in-mongodb/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://jcarloslr10.github.io/posts/effective-strategies-for-dealing-with-regular-expression-queries-in-mongodb/&amp;text=Effective strategies for dealing with regular expression queries in MongoDB - Juan Carlos López" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/effective-strategies-for-dealing-with-regular-expression-queries-in-mongodb/">Effective strategies for dealing with regular expression queries in MongoDB</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/index/">index</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/observable/">observable</a> <a class="post-tag" href="/tags/observer/">observer</a> <a class="post-tag" href="/tags/performance/">performance</a> <a class="post-tag" href="/tags/queue/">queue</a> <a class="post-tag" href="/tags/regex/">regex</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/concurrent-task-queue-using-rxjs/"><div class="card-body"> <em class="timeago small" data-ts="1652565600" > 2022-05-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Concurrent task queue using RxJS</h3><div class="text-muted small"><p> So far so good Web applications have always needed to run different tasks based on events triggered by the end-user. Long ago, when browsers were more restricted, these applications had to run tas...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/concurrent-task-queue-using-rxjs/" class="btn btn-outline-primary" prompt="Newer"><p>Concurrent task queue using RxJS</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "jcarloslr10/jcarloslr10.github.io", "data-repo-id": "R_kgDOHPdYDQ", "data-category": "Comments", "data-category-id": "DIC_kwDOHPdYDc4CO5Q8", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/jcarloslr10">Juan Carlos López</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/index/">index</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/observable/">observable</a> <a class="post-tag" href="/tags/observer/">observer</a> <a class="post-tag" href="/tags/performance/">performance</a> <a class="post-tag" href="/tags/queue/">queue</a> <a class="post-tag" href="/tags/regex/">regex</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-N2KTFCE5LB"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-N2KTFCE5LB'); }); </script>
